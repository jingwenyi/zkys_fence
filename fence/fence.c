#include "fence.h"
#include <stdbool.h>
#include <math.h>
#include <float.h>

#define M_PI  3.14159265358979323846
#define MAX(a, b)   (((a) > (b)) ? (a) : (b))
// radius of earth in meters
#define RADIUS_OF_EARTH 6378100

#define DEG_TO_RAD      (M_PI / 180.0f)
#define RAD_TO_DEG      (180.0f / M_PI)

// scaling factor from 1e-7 degrees to meters at equater
// == 1.0e-7 * DEG_TO_RAD * RADIUS_OF_EARTH
#define LOCATION_SCALING_FACTOR 0.011131884502145034f
// inverse of LOCATION_SCALING_FACTOR
#define LOCATION_SCALING_FACTOR_INV 89.83204953368922f



static struct zkys_location china_mogolia_boundary[] ={
	{116.729393,49.854168}, {116.58296,49.658115}, {116.430513,49.430679}, {116.047704,48.87526}, {116.0842,48.823788},
	{115.801001,48.531227}, {115.826857,48.264035}, {115.535449,48.159724}, {115.538955,48.142963}, {115.548644,48.142119},
	{115.551073,48.139355}, {115.549629,48.130517}, {115.535719,48.1179}, {115.542452,48.10903}, {115.546403,48.109534},
	{115.587425,47.927536}, {115.948684,47.688954}, {115.972661,47.695459}, {116.125229,47.825798}, {116.273024,47.88834},
	{116.289807,47.887544}, {116.295613,47.880692}, {116.339539,47.868572}, {116.414546,47.854697}, {116.45561,47.844459},
	{116.662556,47.890871}, {116.756391,47.904903}, {116.884445,47.896905}, {116.983993,47.863047}, {117.096693,47.830779},
	{117.13277,47.810402}, {117.208886,47.756353}, {117.228013,47.744939}, {117.24544,47.740496}, {117.387577,47.649275},
	{117.494384,47.767012}, {117.531043,47.779527}, {117.539386,47.796613},{117.5879,47.838705}, {117.817447,48.021911},
	{117.824192,48.024609}, {117.902392,48.032287}, {117.911203,48.030549}, {117.912907,48.028083}, {117.927888,48.030018},
	{117.934671,48.022914}, {117.953318,48.023668}, {117.958996,48.019361}, {117.968098,48.017326}, {117.969235,48.02209},
	{117.9738,48.023991}, {117.978377,48.020921}, {117.989258,48.023886}, {117.996116,48.022905}, {117.996736,48.018233},
	{118.003052,48.016456}, {118.010517,48.018249}, {118.015672,48.016305}, {118.020875,48.020283}, {118.025675,48.018197},
	{118.034785,48.020747}, {118.056874,48.019631}, {118.059696,48.021788}, {118.053766,48.024513}, {118.054043,48.027385},
	{118.0631,48.025296}, {118.067342,48.029573}, {118.073444,48.029187}, {118.079233,48.032975}, {118.084915,48.03225},
	{118.08804,48.037395}, {118.092889,48.034154}, {118.101732,48.036363}, {118.104877,48.04261}, {118.116884,48.037074},
	{118.11946,48.047124}, {118.123466,48.050096}, {118.12889,48.047346}, {118.12889,48.053055}, {118.141704,48.043019},
	{118.149357,48.040335}, {118.149928,48.043765}, {118.160939,48.04346}, {118.167703,48.0504}, {118.186274,48.056792},
	{118.191896,48.054587}, {118.195268,48.047754}, {118.212538,48.050047}, {118.227624,48.046419}, {118.237049,48.048729},
	{118.242763,48.047645}, {118.247896,48.044509}, {118.246162,48.036536}, {118.259265,48.033123}, {118.262946,48.028332},
	{118.273457,48.03025}, {118.274846,48.024157}, {118.285576,48.021044}, {118.284415,48.015121}, {118.293175,48.016792},
	{118.306982,48.01171}, {118.311791,48.011968}, {118.318901,48.018141}, {118.33511,48.013946}, {118.348572,48.015684},
	{118.355725,48.013085}, {118.362918,48.01657}, {118.369202,48.013611}, {118.373242,48.020236}, {118.380969,48.022065},
	{118.404762,48.018365}, {118.415662,48.021684}, {118.421116,48.018618}, {118.429309,48.021604}, {118.449059,48.009047},
	{118.452109,48.001824}, {118.470212,48.004764}, {118.573055,48.000619}, {118.772217,47.781523}, {119.136553,47.672602},
	{119.157692,47.550552}, {119.209024,47.528968}, {119.374931,47.485503}, {119.342764,47.45714}, {119.336942,47.434319},
	{119.340683,47.431703}, {119.336692,47.429548}, {119.343075,47.428744}, {119.348594,47.43787}, {119.353869,47.435645},
	{119.361831,47.436989}, {119.358175,47.432028}, {119.369162,47.429779}, {119.378323,47.423781}, {119.372534,47.422693},
	{119.381267,47.414868}, {119.376574,47.409847}, {119.386415,47.41031}, {119.393296,47.403351}, {119.403567,47.404563},
	{119.403118,47.39712}, {119.411093,47.398074}, {119.41621,47.395962}, {119.415103,47.389657}, {119.418921,47.388811},
	{119.422835,47.393108}, {119.426192,47.391562}, {119.431427,47.38641}, {119.426626,47.385084}, {119.427112,47.382501},
	{119.445059,47.384099}, {119.450941,47.376496}, {119.448271,47.373643}, {119.451189,47.366484}, {119.458423,47.363767},
	{119.457962,47.356763}, {119.461569,47.355489}, {119.469478,47.357845}, {119.47286,47.348174}, {119.493647,47.341936},
	{119.489253,47.33424}, {119.495286,47.334262}, {119.495973,47.331559}, {119.500523,47.332405}, {119.502044,47.329878},
	{119.505934,47.332401}, {119.509089,47.33105}, {119.511909,47.33469}, {119.514312,47.329883}, {119.519709,47.331264},
	{119.517699,47.328083}, {119.525614,47.328903}, {119.528677,47.323212}, {119.534697,47.325668}, {119.531234,47.321368},
	{119.536029,47.322664}, {119.539103,47.316796}, {119.535985,47.315366}, {119.531302,47.318224}, {119.533547,47.311791},
	{119.539436,47.3115}, {119.545028,47.315335}, {119.542641,47.30906}, {119.545421,47.307043}, {119.552305,47.309839},
	{119.556155,47.30766}, {119.567111,47.307846}, {119.564857,47.295284}, {119.573124,47.292799}, {119.56789,47.291253},
	{119.570699,47.287661}, {119.574869,47.289507}, {119.575378,47.285502}, {119.569107,47.283519}, {119.564589,47.287985},
	{119.562743,47.285567}, {119.568143,47.279092}, {119.572716,47.28222}, {119.575513,47.279204}, {119.570409,47.271782},
	{119.572246,47.26462}, {119.566785,47.264074}, {119.56579,47.261793}, {119.574804,47.253603}, {119.588692,47.251527},
	{119.617826,47.255364}, {119.63752,47.252459}, {119.640743,47.248947}, {119.64557,47.248875}, {119.645656,47.245013},
	{119.654317,47.243511}, {119.670609,47.232625}, {119.691289,47.215499}, {119.724004,47.201923}, {119.731096,47.174112},
	{119.76992,47.138462}, {119.814127,47.065271}, {119.802808,47.05626}, {119.80563,47.038945}, {119.798069,47.033211},
	{119.808017,47.016324}, {119.816966,47.009527}, {119.830058,46.991456}, {119.844684,46.9839}, {119.851259,46.975114},
	{119.878717,46.972172}, {119.880775,46.963672}, {119.861718,46.947083}, {119.868114,46.927573}, {119.93508,46.90924},
	{119.921023,46.907989}, {119.922487,46.899411}, {119.912862,46.889758}, {119.914125,46.879175}, {119.910369,46.872268},
	{119.917705,46.859872}, {119.92847,46.855406}, {119.945642,46.854702}, {119.943679,46.851261}, {119.934672,46.847999},
	{119.931813,46.836235}, {119.941356,46.820186}, {119.945893,46.795671}, {119.943841,46.792069}, {119.938643,46.793631},
	{119.93728,46.786651}, {119.915413,46.773308}, {119.921689,46.767951}, {119.913671,46.765578}, {119.913254,46.762753},
	{119.923536,46.75725}, {119.928801,46.73865}, {119.944027,46.729101}, {119.939029,46.7135}, {119.919396,46.696601},
	{119.915885,46.673808}, {119.903038,46.671807}, {119.859691,46.67855}, {119.842205,46.677321}, {119.813176,46.691486},
	{119.818933,46.670983}, {119.78983,46.635352}, {119.756355,46.619002}, {119.744844,46.622902}, {119.725293,46.607118},
	{119.702963,46.600963}, {119.694053,46.593685}, {119.682269,46.621913}, {119.665012,46.632143}, {119.65145,46.634265},
	{119.605681,46.626297}, {119.595273,46.620341}, {119.591926,46.627615}, {119.580451,46.629559}, {119.568883,46.641554},
	{119.551578,46.64355}, {119.533305,46.643783}, {119.489804,46.636238}, {119.449084,46.647608}, {119.443829,46.647209},
	{119.38976,46.613636}, {119.381949,46.612624}, {119.359582,46.626006}, {119.353697,46.624161}, {119.349464,46.618891},
	{119.337497,46.616657}, {119.313551,46.617573}, {119.287267,46.633856}, {119.277894,46.636329}, {119.270584,46.643891},
	{119.272157,46.649851}, {119.259595,46.651343}, {119.239105,46.658289}, {119.234469,46.657916}, {119.230145,46.653689},
	{119.212004,46.653546}, {119.208667,46.656578}, {119.201448,46.651844}, {119.17603,46.663521}, {119.166736,46.663678},
	{119.143315,46.657872}, {119.138452,46.660843}, {119.135577,46.654285}, {119.116185,46.654551}, {119.11519,46.660835},
	{119.095324,46.669307}, {119.054412,46.707852}, {119.026438,46.737565}, {119.02801,46.743318}, {119.021896,46.752812},
	{119.007925,46.755619}, {118.989624,46.746232}, {118.976852,46.7458}, {118.951655,46.728744}, {118.944267,46.728648},
	{118.940713,46.73202}, {118.929059,46.73053}, {118.914784,46.740538}, {118.926633,46.74611}, {118.923846,46.77282},
	{118.920174,46.779054}, {118.909175,46.783263}, {118.879014,46.775812}, {118.845734,46.775165}, {118.846157,46.77077},
	{118.829207,46.752566}, {118.796039,46.724075}, {118.79506,46.717303}, {118.801898,46.709992}, {118.80091,46.705134},
	{118.805713,46.696881}, {118.802468,46.694564}, {118.790508,46.697003}, {118.774175,46.693673}, {118.761798,46.698685},
	{118.743484,46.697431}, {118.734556,46.703309}, {118.685929,46.704922}, {118.676706,46.708894}, {118.660623,46.725565},
	{118.643488,46.725313}, {118.58939,46.700924}, {118.513774,46.707989}, {118.451413,46.715599}, {118.415478,46.736898},
	{118.323505,46.748192}, {118.310308,46.743076}, {118.283096,46.726102}, {118.242906,46.721597}, {118.235008,46.717013},
	{118.229902,46.704187}, {118.199724,46.690324}, {118.169339,46.692814}, {118.128734,46.686224}, {118.124117,46.684166},
	{118.121335,46.674242}, {118.099875,46.665566}, {118.079338,46.65149}, {118.047774,46.636269}, {117.999723,46.637683},
	{117.994873,46.633508}, {117.999369,46.625057}, {117.992022,46.621579}, {117.980113,46.620444}, {117.951664,46.624573},
	{117.938851,46.622769}, {117.911181,46.606914}, {117.90437,46.598836}, {117.903579,46.590216}, {117.888929,46.588066},
	{117.874103,46.581801}, {117.870766,46.569199}, {117.878516,46.553545}, {117.868611,46.544608}, {117.848533,46.540802},
	{117.843121,46.536151}, {117.811643,46.538778}, {117.806437,46.535359}, {117.785038,46.543263}, {117.772864,46.531023},
	{117.760455,46.531171}, {117.752657,46.527092}, {117.738484,46.526945}, {117.730697,46.521322}, {117.720328,46.52095},
	{117.697879,46.528368}, {117.648165,46.561002}, {117.646449,46.581496}, {117.636977,46.596778}, {117.625924,46.603974},
	{117.60184,46.611844}, {117.590906,46.601718}, {117.557422,46.608261}, {117.536261,46.606097}, {117.527214,46.597776},
	{117.515908,46.605049}, {117.500871,46.606807}, {117.456689,46.590737}, {117.428958,46.588858}, {117.454055,46.533845},
	{117.404396,46.483181}, {117.383892,46.417512}, {117.393525,46.405146}, {117.382916,46.369004}, {117.25718,46.373056},
	{117.103146,46.362915}, {117.033862,46.368874}, {116.909609,46.38418}, {116.899314,46.381219}, {116.872419,46.383779},
	{116.849054,46.391397}, {116.835666,46.387205}, {116.82868,46.380929}, {116.824703,46.361962}, {116.783504,46.351354},
	{116.773952,46.340952}, {116.774897,46.336799}, {116.66839,46.328014}, {116.612886,46.31042}, {116.591751,46.296253},
	{116.580068,46.260596}, {116.531996,46.227384}, {116.448794,46.145358}, {116.430127,46.141963}, {116.415315,46.134247},
	{116.277898,45.969724}, {116.262408,45.910599}, {116.250429,45.892425}, {116.249601,45.882183}, {116.271954,45.869672},
	{116.269925,45.863655}, {116.28141,45.858548}, {116.280879,45.85158}, {116.290482,45.848206}, {116.284542,45.837446},
	{116.293278,45.7793}, {116.272796,45.778211}, {116.224653,45.748752}, {116.226861,45.730643}, {116.203629,45.709007},
	{116.186912,45.699334}, {116.163977,45.692289}, {116.141941,45.690875}, {116.130543,45.684104}, {116.089703,45.690921},
	{116.053707,45.691942}, {116.039569,45.689818}, {116.033376,45.668769}, {115.944212,45.638566}, {115.81878,45.543491},
	{115.703212,45.467108}, {115.571184,45.444376}, {115.370785,45.397102}, {115.178284,45.404875}, {115.036117,45.389225},
	{115.01557,45.389642}, {114.996336,45.383682}, {114.925477,45.390562}, {114.875008,45.408956}, {114.75033,45.445751},
	{114.693467,45.427651}, {114.597516,45.406025}, {114.556563,45.392616}, {114.549758,45.344684}, {114.533602,45.301839},
	{114.47633,45.227499}, {114.415161,45.179688}, {114.357445,45.129122}, {114.316553,45.111893}, {114.219589,45.054467},
	{114.197461,45.044182}, {114.190289,45.044798}, {114.166238,44.99916}, {114.12207,44.96148}, {114.069018,44.934047},
	{114.014356,44.934593}, {114.003978,44.929344}, {113.990689,44.932209}, {113.953425,44.920155}, {113.915477,44.920001},
	{113.911617,44.916585}, {113.910962,44.906234}, {113.894849,44.900091}, {113.894742,44.887625}, {113.883566,44.880051},
	{113.873086,44.880173}, {113.869386,44.870574}, {113.853045,44.868522}, {113.809019,44.85619}, {113.796015,44.849466},
	{113.708375,44.785867}, {113.642194,44.75142}, {113.551481,44.764624}, {113.532145,44.776829}, {113.514633,44.783332},
	{113.134654,44.804237}, {113.034244,44.833118}, {113.011669,44.833254}, {112.938025,44.848533}, {112.859908,44.846523},
	{112.844856,44.855419}, {112.806033,44.861133}, {112.717797,44.886371}, {112.607005,44.936467}, {112.54615,45.006645},
	{112.538448,45.008136}, {112.534746,45.015302}, {112.436182,45.083539}, {112.404187,45.070132}, {112.3851,45.068801},
	{112.185135,45.079647}, {112.121087,45.079787}, {112.099189,45.089197}, {112.077555,45.102645}, {112.013652,45.098266},
	{111.984672,45.091886}, {111.965589,45.079785}, {111.898778,45.052902}, {111.811574,45.007562}, {111.78237,44.988651},
	{111.753348,44.95636}, {111.705529,44.876613}, {111.631988,44.785094}, {111.612603,44.751066}, {111.614898,44.744721},
	{111.608663,44.741506}, {111.592064,44.711667},{111.568513,44.654019}, {111.577629,44.58545}, {111.574791,44.57833},
	{111.568502,44.572094}, {111.540241,44.557533}, {111.525403,44.516986}, {111.514063,44.514191}, {111.487641,44.49521},
	{111.437098,44.404842}, {111.425036,44.364492}, {111.438056,44.327586}, {111.49175,44.314246}, {111.511535,44.304297},
	{111.524805,44.29341}, {111.531847,44.280587}, {111.539253,44.276531}, {111.541612,44.2713}, {111.537343,44.261452},
	{111.542469,44.253036}, {111.541482,44.246167}, {111.547125,44.238543}, {111.54846,44.213169}, {111.568052,44.176593},
	{111.604358,44.143108}, {111.61349,44.124038}, {111.668126,44.070297}, {111.692653,44.049856}, {111.706666,44.042921},
	{111.754131,44.020731}, {111.796431,44.008031}, {111.884508,43.941567}, {111.969754,43.826705}, {111.975414,43.804847},
	{111.979339,43.755388}, {111.959856,43.698615}, {111.936259,43.694656}, {111.897404,43.680732}, {111.800906,43.676845},
	{111.617998,43.521099}, {111.572826,43.496311}, {111.514343,43.494834}, {111.46071,43.497565}, {111.403822,43.477036},
	{111.361267,43.441855}, {111.330082,43.432541}, {111.272593,43.423464}, {111.183616,43.397674}, {111.158296,43.384959},
	{111.075786,43.362907}, {111.068664,43.353772}, {111.026155,43.334876}, {111.004197,43.319566}, {110.963693,43.283547},
	{110.779013,43.108879}, {110.739927,43.092338}, {110.69484,43.045625}, {110.694176,43.023978}, {110.635045,42.942237},
	{110.475557,42.842876}, {110.444612,42.787955}, {110.347948,42.743656}, {110.144349,42.67975}, {110.113807,42.648635},
	{109.908917,42.640474}, {109.690353,42.56676}, {109.547385,42.477478}, {109.513126,42.474667}, {109.492248,42.46326},
	{109.323904,42.448469}, {109.296998,42.442249}, {109.030122,42.463843}, {109.014722,42.453087}, {109.005528,42.459592},
	{108.956017,42.44544}, {108.851571,42.404792}, {108.841385,42.412168}, {108.801482,42.422522}, {108.709358,42.422252},
	{108.549028,42.449782}, {108.467635,42.450944}, {108.308334,42.444981}, {108.255354,42.470327}, {108.19416,42.457661},
	{108.101309,42.44448}, {108.030246,42.440823}, {107.990592,42.420673}, {107.97327,42.420055}, {107.942796,42.409209},
	{107.735296,42.420931}, {107.58466,42.417245}, {107.57941,42.417975}, {107.507075,42.462862}, {107.472395,42.464523},
	{107.303491,42.416351}, {107.2986,42.413373}, {107.277037,42.37091}, {107.270729,42.368553}, {107.059725,42.323986},
	{106.795995,42.299203}, {106.664387,42.261752}, {106.420628,42.180904}, {106.136533,42.079422}, {105.952415,42.016799},
	{105.921846,42.004016}, {105.727139,41.945363}, {105.597162,41.892732}, {105.529751,41.858269}, {105.398045,41.804463},
	{105.371351,41.785942}, {105.300463,41.755376}, {105.240148,41.756336}, {105.01628,41.589956}, {104.927027,41.662433},
	{104.691469,41.652788}, {104.527308,41.669091}, {104.534604,41.882847}, {104.084198,41.811776}, {103.863603,41.807764},
	{103.750604,41.832857}, {103.621348,41.853029}, {103.423106,41.890125}, {103.001741,42.043715}, {102.721255,42.158378},
	{102.651179,42.159136}, {102.55031,42.168215}, {102.455401,42.152509}, {102.086136,42.233291}, {101.80948,42.511071},
	{101.576951,42.533293}, {100.857642,42.678958}, {100.327586,42.69527}, {100.277796,42.649361}, {100.276529,42.64336},
	{99.976928,42.656281}, {99.51158,42.574045}, {98.541679,42.645666}, {98.203169,42.660672}, {97.546163,42.753454},
	{97.179368,42.801545}, {96.983691,42.761849}, {96.755707,42.762106}, {96.395571,42.731938}, {96.370284,42.907035},
	{95.916574,43.243314}, {95.887087,43.281482}, {95.883445,43.287794}, {95.864457,43.421558}, {95.743269,43.600758},
	{95.7199,43.65555}, {95.656447,43.779433}, {95.629654,43.857518}, {95.531608,44.012255}, {95.454679,44.011959},
	{95.431224,44.016081}, {95.382662,44.031121}, {95.332208,44.032858}, {95.355625,44.096246}, {95.360485,44.170321},
	{95.381215,44.234572}, {95.412485,44.248919}, {95.430854,44.273023}, {95.43285,44.28834}, {95.42038,44.300452},
	{95.408161,44.302918}, {95.374379,44.296415}, {95.198776,44.277816}, {95.127305,44.274073}, {95.006947,44.258359},
	{94.993269,44.266541}, {94.987608,44.266504}, {94.945431,44.299544}, {94.917512,44.307905}, {94.905075,44.307315},
	{94.888466,44.31596}, {94.830449,44.326091}, {94.818691,44.333257}, {94.803626,44.336318}, {94.792069,44.344229},
	{94.774288,44.346759}, {94.731891,44.345958}, {94.721452,44.351694}, {94.680323,44.401127}, {94.609978,44.454936},
	{94.563816,44.467124}, {94.525721,44.486304}, {94.498258,44.506181}, {94.470417,44.518109}, {94.397661,44.529828},
	{94.369564,44.521999}, {94.355982,44.524208}, {94.351598,44.531477}, {94.355778,44.548487}, {94.347332,44.571769},
	{94.33511,44.58865}, {94.320133,44.597676}, {94.284281,44.611492}, {94.229126,44.654545}, {94.227842,44.663367},
	{94.220013,44.675796}, {94.156819,44.692252}, {94.069978,44.740355}, {93.741312,44.870041}, {93.736916,44.869415},
	{93.719825,44.882888}, {93.72155,44.895139}, {93.718306,44.904459}, {93.709413,44.902586}, {93.692169,44.906508},
	{93.6861,44.914719}, {93.603804,44.939437}, {93.587889,44.948194}, {93.551371,44.956356}, {93.545825,44.962698},
	{93.531118,44.964773}, {93.514333,44.975568}, {93.510323,44.974592}, {93.509178,44.964288}, {93.488251,44.975089},
	{93.471169,44.966068}, {93.450878,44.968534}, {93.436207,44.964688}, {93.411101,44.979459}, {93.406772,44.985669},
	{93.388343,44.98959}, {93.376595,44.997008}, {93.367481,44.994314}, {93.35751,44.996839}, {93.346621,44.996105},
	{93.330631,45.002559}, {93.322392,44.987515}, {93.307089,44.992884}, {93.29369,44.990414}, {93.215748,45.008517},
	{93.176639,45.020168}, {93.163629,45.017431}, {93.141247,45.022209}, {93.133494,45.017312}, {93.097307,45.015064},
	{93.0552,45.024649}, {93.020007,45.018187}, {93.007745,45.018414}, {92.987314,45.007848}, {92.977961,45.022204},
	{92.936833,45.022307}, {92.929596,45.034872}, {92.931187,45.040946}, {92.909437,45.043227}, {92.905631,45.048572},
	{92.902363,45.047374}, {92.896313,45.053434}, {92.887113,45.053891}, {92.877005,45.0465}, {92.869993,45.048788},
	{92.857912,45.043923}, {92.810359,45.050215}, {92.784137,45.057519}, {92.777705,45.051499}, {92.746429,45.049269},
	{92.733819,45.042521}, {92.690579,45.033064}, {92.641579,45.028854}, {92.614619,45.029812}, {92.591789,45.024459},
	{92.578286,45.027075}, {92.546533,45.025149}, {92.519179,45.013318}, {92.494033,45.007918}, {92.471387,45.009687},
	{92.464387,45.014996}, {92.454884,45.01521}, {92.42001,45.025547}, {92.351114,45.019836}, {92.320265,45.034621},
	{92.271306,45.0269}, {92.255953,45.029816}, {92.242277,45.020618}, {92.20311,45.042124}, {92.102946,45.085216},
	{92.059754,45.090361}, {91.898556,45.085082}, {91.808614,45.089552}, {91.711338,45.072867}, {91.688612,45.071359},
	{91.672298,45.074182}, {91.625011,45.074846}, {91.578246,45.090516}, {91.568462,45.078514}, {91.54272,45.096136},
	{91.527214,45.099327}, {91.50429,45.109726}, {91.493412,45.133021}, {91.477342,45.144539}, {91.467881,45.156888},
	{91.458427,45.161871}, {91.438068,45.164431}, {91.431986,45.162027}, {91.396646,45.133529}, {91.394517,45.12113},
	{91.389545,45.117739}, {91.376801,45.118074}, {91.356705,45.128334}, {91.345116,45.130528}, {91.33709,45.136383},
	{91.326471,45.134583}, {91.263948,45.141403}, {91.251633,45.13921}, {91.23223,45.160354}, {91.202753,45.163266},
	{91.194998,45.173378}, {91.185103,45.17681}, {91.177121,45.184422}, {91.172573,45.206059}, {91.132166,45.221283},
	{91.117063,45.218887}, {91.088979,45.222963}, {91.057458,45.214113}, {91.026435,45.220321}, {91.004301,45.22073},
	{90.967054,45.206146}, {90.934803,45.200324}, {90.887346,45.19704}, {90.888291,45.200535}, {90.873558,45.210905},
	{90.903414,45.257614}, {90.880225,45.287172}, {90.84325,45.305669}, {90.811169,45.296372}, {90.81848,45.331121},
	{90.780556,45.410578}, {90.779395,45.437242}, {90.753271,45.45821}, {90.700833,45.479564}, {90.677556,45.494412},
	{90.676602,45.553856}, {90.686885,45.61198}, {90.720869,45.727301}, {90.720291,45.735665}, {90.853713,45.891675},
	{90.852191,45.897491}, {90.857913,45.895716}, {91.029853,46.029043}, {91.027282,46.063528}, {91.017092,46.085163},
	{91.023789,46.091277}, {91.018487,46.106947}, {91.020174,46.130425}, {90.982879,46.168522}, {90.953442,46.221448},
	{90.953006,46.233101}, {90.958045,46.236401}, {90.897743,46.319048}, {90.912481,46.320597}, {90.922588,46.332266},
	{90.93671,46.340137}, {90.945013,46.349151}, {90.980144,46.371145}, {91.001398,46.428953}, {91.017601,46.443563},
	{91.016306,46.460896}, {91.024539,46.472913}, {91.024715,46.478538}, {91.028696,46.481884}, {91.03548,46.482613},
	{91.035394,46.48936}, {91.042335,46.497047}, {91.039449,46.502366}, {91.045397,46.512882}, {91.050513,46.517824},
	{91.059661,46.51983}, {91.058205,46.530063}, {91.063704,46.537306}, {91.058819,46.54159}, {91.059596,46.545523},
	{91.064977,46.547497}, {91.068991,46.557333}, {91.08161,46.566277}, {91.082057,46.573578}, {91.074415,46.587157},
	{91.022555,46.584928}, {91.023752,46.620298}, {91.055074,46.729364}, {91.037109,46.751672}, {91.025471,46.756996},
	{91.023379,46.771299}, {90.998447,46.776517}, {90.992327,46.804041}, {90.986971,46.802382}, {90.973945,46.805372},
	{90.973468,46.811228}, {90.961589,46.822136}, {90.95228,46.824553}, {90.945979,46.830541}, {90.945149,46.840973},
	{90.960497,46.858807}, {90.962863,46.884926}, {90.95711,46.892114}, {90.941077,46.893863}, {90.939736,46.901274},
	{90.921622,46.9243}, {90.92352,46.938786}, {90.928584,46.945302}, {90.915883,46.950044}, {90.90873,46.962644},
	{90.898426,46.969357}, {90.865315,46.984552}, {90.85903,46.996088}, {90.84899,46.993651}, {90.835807,46.99729},
	{90.827871,47.003238}, {90.778659,46.997794}, {90.768606,47.000597}, {90.765175,47.006926}, {90.769338,47.012365},
	{90.760073,47.025203}, {90.751362,47.032509}, {90.737657,47.034152}, {90.725728,47.056227}, {90.71656,47.059885},
	{90.700371,47.080924}, {90.699599,47.088383}, {90.674511,47.100379}, {90.668209,47.105946}, {90.668088,47.112431},
	{90.6578,47.117392}, {90.659756,47.138633}, {90.635097,47.142796}, {90.636107,47.149444}, {90.628096,47.155018},
	{90.626961,47.165332}, {90.602823,47.17442}, {90.589921,47.201704}, {90.567009,47.211722}, {90.566041,47.230374},
	{90.555251,47.242077}, {90.543901,47.24716}, {90.545107,47.258319}, {90.536218,47.264643}, {90.53791,47.275169},
	{90.527982,47.284246}, {90.531434,47.290432}, {90.519235,47.299608}, {90.518908,47.305286}, {90.510959,47.312133},
	{90.503135,47.314015}, {90.498963,47.320708}, {90.490765,47.321648}, {90.484103,47.329331}, {90.494741,47.33229},
	{90.513321,47.345347}, {90.511373,47.353826}, {90.505042,47.356505}, {90.504006,47.360159}, {90.529016,47.383853},
	{90.510203,47.40932}, {90.503497,47.410024}, {90.490926,47.404019}, {90.485188,47.404105}, {90.479648,47.405377},
	{90.464232,47.41703}, {90.467478,47.426394}, {90.46228,47.445655}, {90.47518,47.4592}, {90.479147,47.47389},
	{90.474091,47.484545}, {90.478478,47.497858}, {90.469821,47.507891}, {90.464106,47.507983}, {90.458231,47.511525},
	{90.455221,47.522275}, {90.445469,47.531606}, {90.421803,47.544165}, {90.405964,47.548532}, {90.405203,47.560823},
	{90.397874,47.569242}, {90.399374,47.577365}, {90.395031,47.586343}, {90.386561,47.59364}, {90.389563,47.599425},
	{90.383757,47.607732}, {90.371511,47.614707}, {90.367456,47.62373}, {90.352692,47.634389}, {90.352236,47.643878},
	{90.360082,47.653938}, {90.367847,47.650992}, {90.380305,47.653314}, {90.374435,47.667532}, {90.356589,47.681824},
	{90.338489,47.686554}, {90.329723,47.692827}, {90.318699,47.693916}, {90.303475,47.700756}, {90.263451,47.702741},
	{90.250465,47.716897}, {90.233245,47.710844}, {90.221168,47.714134}, {90.215268,47.719943}, {90.206669,47.721535},
	{90.20149,47.727561}, {90.191692,47.728067}, {90.186291,47.73387}, {90.167511,47.730157}, {90.154639,47.732092},
	{90.148331,47.729756}, {90.132151,47.73914}, {90.127685,47.754284}, {90.115149,47.757293}, {90.100853,47.768838},
	{90.091455,47.772718}, {90.080873,47.785532}, {90.080493,47.795193}, {90.076683,47.799754}, {90.082547,47.8058}, 
	{90.076214,47.810359}, {90.078334,47.817496}, {90.074377,47.825648}, {90.079882,47.846557}, {90.077192,47.851496},
	{90.082776,47.858838}, {90.088788,47.86023}, {90.089441,47.864384}, {90.098587,47.868188}, {90.093898,47.870955},
	{90.091314,47.878185}, {90.078882,47.878691}, {90.065736,47.892768}, {90.061563,47.890299}, {90.05889,47.882368},
	{90.047017,47.880454}, {90.037762,47.884833}, {90.02848,47.883184}, {90.022454,47.887776}, {90.008584,47.889034},
	{90.004371,47.887053}, {89.993068,47.889215}, {89.984936,47.886534}, {89.965834,47.892385}, {89.961238,47.888369},
	{89.964699,47.882793}, {89.963759,47.867491}, {89.958098,47.863156}, {89.963361,47.856794}, {89.958107,47.84627},
	{89.960377,47.839288}, {89.933503,47.838189}, {89.897471,47.846041}, {89.85802,47.83529}, {89.850402,47.838928},
	{89.83279,47.837451}, {89.811972,47.841844}, {89.802456,47.841394}, {89.787088,47.834782}, {89.768242,47.837232},
	{89.767852,47.844112}, {89.761971,47.849172}, {89.759813,47.865222}, {89.748212,47.873674}, {89.758385,47.880153},
	{89.759903,47.884695}, {89.733975,47.906605}, {89.725727,47.905036}, {89.709466,47.906635}, {89.692,47.911789},
	{89.661318,47.913868}, {89.648765,47.930957}, {89.649397,47.952207}, {89.639387,47.956084}, {89.625728,47.95676},
	{89.61949,47.967125}, {89.601468,47.97352}, {89.594821,48.004078}, {89.611061,48.016336}, {89.604565,48.026303},
	{89.594015,48.031393}, {89.587842,48.039528}, {89.541311,48.044411}, {89.522184,48.041291}, {89.50543,48.033623},
	{89.448027,48.040359}, {89.427012,48.04123}, {89.412623,48.039144}, {89.390763,48.052536}, {89.385442,48.04945},
	{89.378398,48.031425}, {89.36669,48.024909}, {89.349044,48.029817}, {89.337918,48.028553}, {89.321306,48.021631},
	{89.303699,48.020913}, {89.299117,48.017303}, {89.28883,47.995338}, {89.274033,47.994956}, {89.266521,47.998243},
	{89.262604,47.997407}, {89.252108,47.986497}, {89.244241,47.982839}, {89.217714,47.983699}, {89.197749,47.98808},
	{89.187813,47.995816}, {89.16498,48.002141}, {89.139751,47.993503}, {89.122362,47.991816}, {89.070441,47.995384},
	{89.066801,47.996937}, {89.068053,48.000705}, {89.061085,48.016022}, {89.049766,48.019688}, {89.042136,48.035619},
	{89.019449,48.050902}, {89.018781,48.058082}, {88.999461,48.06838}, {88.994028,48.075942}, {88.979612,48.077447},
	{88.975152,48.084402}, {88.962213,48.093061}, {88.957925,48.100561}, {88.943516,48.103914}, {88.941657,48.107459},
	{88.944299,48.110507}, {88.940446,48.114238}, {88.931042,48.111765}, {88.917111,48.116014}, {88.905954,48.116305},
	{88.889809,48.113449}, {88.882227,48.115507}, {88.868453,48.113462}, {88.852302,48.118694}, {88.841728,48.111219},
	{88.83105,48.108269}, {88.823539,48.114242}, {88.815601,48.11534}, {88.81104,48.125992}, {88.788659,48.139342},
	{88.775659,48.137774}, {88.76734,48.140566}, {88.753395,48.157459}, {88.746954,48.158716}, {88.74166,48.163412},
	{88.727654,48.161598}, {88.718298,48.16429}, {88.716148,48.169218}, {88.724004,48.181149}, {88.701413,48.186123},
	{88.675337,48.175408}, {88.64617,48.185866}, {88.637615,48.197916}, {88.636701,48.210001}, {88.628125,48.218858},
	{88.608344,48.225596}, {88.596146,48.224737}, {88.596586,48.233447}, {88.604983,48.252361}, {88.597545,48.25966},
	{88.596549,48.26611}, {88.57533,48.282604}, {88.612287,48.33381}, {88.611498,48.344743}, {88.599232,48.350657},
	{88.585584,48.351583}, {88.582483,48.356741}, {88.575585,48.358125}, {88.582057,48.373936}, {88.568477,48.3727},
	{88.556456,48.378358}, {88.546069,48.37127}, {88.527878,48.382374}, {88.520276,48.391262}, {88.529569,48.396548},
	{88.523088,48.407958}, {88.51634,48.410793}, {88.509407,48.409495}, {88.494152,48.41275}, {88.485144,48.40257},
	{88.448741,48.393501}, {88.434242,48.408612}, {88.402682,48.419826}, {88.380163,48.436316}, {88.360018,48.440687},
	{88.360291,48.448328}, {88.356093,48.453489}, {88.367591,48.465903}, {88.360509,48.470623}, {88.347991,48.473017},
	{88.339446,48.47906}, {88.32487,48.481317}, {88.300708,48.491322}, {88.278959,48.494112}, {88.264218,48.500773},
	{88.262207,48.50592}, {88.253401,48.506933}, {88.242263,48.504573}, {88.224122,48.510083}, {88.20726,48.506413},
	{88.201871,48.502354}, {88.184271,48.506083}, {88.155365,48.52755}, {88.15103,48.535111}, {88.141029,48.534925},
	{88.128615,48.530841}, {88.122915,48.531795}, {88.11654,48.544824}, {88.108241,48.551495}, {88.095599,48.548231},
	{88.089296,48.554712}, {88.082182,48.555548}, {88.061176,48.548829}, {88.042785,48.556696}, {88.031935,48.55484},
	{88.025261,48.559246}, {88.020094,48.571681}, {88.008582,48.57566}, {87.992257,48.574508}, {87.979795,48.58016},
	{87.973342,48.594246}, {87.96563,48.598917}, {87.967652,48.60314}, {87.974365,48.605671}, {87.982539,48.614762},
	{88.005737,48.622026}, {88.023324,48.632871}, {88.039161,48.638641}, {88.042314,48.641671}, {88.02731,48.653089},
	{88.019562,48.655822}, {88.028461,48.658349}, {88.042582,48.670447}, {88.057449,48.675179}, {88.061712,48.681158},
	{88.077893,48.687424}, {88.094909,48.709153}, {88.100274,48.721543}, {88.081517,48.723695}, {88.064528,48.718981},
	{88.055137,48.735351}, {88.032916,48.755986}, {88.019467,48.759191}, {88.010146,48.766663}, {87.988397,48.771926},
	{87.981514,48.777276}, {87.9687,48.777156}, {87.944366,48.762812}, {87.903657,48.78371}, {87.885875,48.794585},
	{87.882844,48.799765}, {87.871438,48.803028}, {87.865598,48.807937}, {87.853415,48.803028}, {87.833457,48.807726},
	{87.82594,48.812679}, {87.820975,48.823245}, {87.802886,48.829085}, {87.806284,48.831667}, {87.828522,48.830999},
	{87.832609,48.835015}, {87.823976,48.842706}, {87.822149,48.849619}, {87.801113,48.851207}, {87.800992,48.860472},
	{87.792435,48.875479}, {87.756517,48.873139}, {87.749346,48.877167}, {87.74553,48.893231}, {87.762427,48.914049},
	{87.7613,48.921127}, {87.7715,48.926862}, {87.763961,48.938124}, {87.784285,48.935099}, {87.794972,48.936164},
	{87.817071,48.949526}, {87.822885,48.95741}, {87.831432,48.953363}, {87.877727,48.955487}, {87.880367,48.958359},
	{87.875312,48.967813}, {87.877106,48.974846}, {87.889113,48.980978}, {87.904334,48.982288}, {87.908871,48.985059},
	{87.907165,48.991764}, {87.880794,49.000273}, {87.877868,49.004015}, {87.88262,49.007261}, {87.878905,49.011849},
	{87.890091,49.022104}, {87.88593,49.029208}, {87.872968,49.032639}, {87.868845,49.042581}, {87.855262,49.042943},
	{87.844553,49.04671}, {87.837333,49.055012}, {87.844492,49.066514}, {87.858768,49.070684}, {87.862602,49.074925},
	{87.859812,49.082659}, {87.84642,49.088502}, {87.846543,49.099216}, {87.862369,49.104907}, {87.876224,49.119834},
	{87.842563,49.143467}, {87.841185,49.155545}, {87.836175,49.156399}, {87.829626,49.153247}, {87.824977,49.156146},
	{87.829301,49.172311}
};

static bool check_lat(float lat)
{
    return fabsf(lat) <= 90;
}
static bool check_lng(float lng)
{
    return fabsf(lng) <= 180;
}

static float Constrain_float(float amt, float low, float high) 
{
	return ((amt)<(low)?(low):((amt)>(high)?(high):(amt)));
}


static float longitude_scale(const struct zkys_location *loc)
{
    float scale = cos(loc->lat * DEG_TO_RAD);
    return Constrain_float(scale, 0.01f, 1.0f);
}


// return distance in meters between two locations
float zkys_get_distance(const struct zkys_location *loc1, const struct zkys_location *loc2)
{
    float dlat              = (loc2->lat * 1.0e7 - loc1->lat * 1.0e7);
    float dlong             = (loc2->lng *1.0e7 - loc1->lng * 1.0e7) * longitude_scale(loc2);
    return sqrt(pow(dlat, 2)  + pow(dlong, 2)) * LOCATION_SCALING_FACTOR;
}


// return bearing in centi-degrees between two locations
float zkys_get_bearing(const struct zkys_location *loc1, const struct zkys_location *loc2)
{
    float off_x = loc2->lng - loc1->lng;
    float off_y = (loc2->lat - loc1->lat) / longitude_scale(loc2);
    float bearing = 9000.0f + atan2(-off_y, off_x) * 5729.57795f;
    if (bearing < 0) bearing += 36000.0f;
    return bearing / 100.0f;
}

double zkys_wrap_360(const double angle)
{
    double res = fmod(angle, 360.0f);
    if (res < 0) {
        res += 360.0f;
    }
    return res;
}

static bool is_zero(float a)
{
	return fabs(a) < 1.0e-6f ? true : false;
}



/*
 *  extrapolate latitude/longitude given distances north and east
 */
static void location_offset(struct zkys_location *loc, float ofs_north, float ofs_east)
{
    if (!is_zero(ofs_north) || !is_zero(ofs_east)) {
        int dlat = ofs_north * LOCATION_SCALING_FACTOR_INV;
        int dlng = (ofs_east * LOCATION_SCALING_FACTOR_INV) / longitude_scale(loc);
        loc->lat += dlat * 1.0e-7;
        loc->lng += dlng * 1.0e-7;
    }
}



/*
 *  extrapolate latitude/longitude given bearing and distance
 * Note that this function is accurate to about 1mm at a distance of 
 * 100m. This function has the advantage that it works in relative
 * positions, so it keeps the accuracy even when dealing with small
 * distances and floating point numbers
 */
void zkys_location_update(struct zkys_location *loc, float bearing, float distance)
{
    float ofs_north = cos(bearing * DEG_TO_RAD)*distance;
    float ofs_east  = sin(bearing * DEG_TO_RAD)*distance;
    location_offset(loc, ofs_north, ofs_east);
}


/*
*  function : zkys check fence
*  paramter: 	
*		gps_loc : current machine position 
*		distance : fence distance, unit is cm
*		return_distance: the minimum distance of from current to boundary,unit is m, > 0 is constant. if  -1 is indicative of error.
*  return: 
*        	-1 is indicative of error,
*		0 is indicative of machine is not in fence,
*		1 is indicative of machine is in fence.
*/
int zkys_check_fence(struct zkys_location *gps_loc, float *distance)
{
	int i;
	struct zkys_location loc;
	float fence_threshold;
	float distance_tmp;

	if(gps_loc == NULL || distance == NULL)
	{
		printf("gps_loc is NULL or distance is NULL!\n");
		return -1;
	}

	fence_threshold = *distance;
	*distance = -1.0f;
	distance_tmp = -1.0f;

	loc.lat = gps_loc->lat;
	loc.lng = gps_loc->lng;

	if(!check_lat(loc.lat) || !check_lng(loc.lng))
	{
		printf("lat data should <= 90  or lng data should <= 180!\n");
		return -1;
	}
	//printf("current position lat: %f, lng:%f, fence_threshold:%f\n", loc.lat, loc.lng, fence_threshold);
	

	//1.found the minimum distance of from the current loc position to the boundary.
	int mini_index = -1;
	float mini_distance = FLT_MAX;

	
	int max_index = sizeof(china_mogolia_boundary) / sizeof(struct zkys_location);

#if 0  // This way of calculating the index is very slow.
	for(i=0; i<max_index; i++)
	{
		float d = zkys_get_distance(gps_loc, &china_mogolia_boundary[i]);
		if(d < mini_distance)
		{
			mini_index = i;
			mini_distance = d;
		}
	}
#else //fast calculating
	//x*y = num, when x = y = sqrt(num), x+y have mini data.
	int skip_num = sqrt(max_index);
	int mini_index_middle = -1;
	for(i=0; i<max_index;)
	{
		float d = zkys_get_distance(gps_loc, &china_mogolia_boundary[i]);
		if(d < mini_distance)
		{
			mini_index_middle= i;
			mini_distance = d;
		}

		i += skip_num;
	}

	int start = mini_index_middle - skip_num >= 0 ? mini_index_middle - skip_num : 0;
	int end = mini_index_middle + skip_num <= max_index ? mini_index_middle + skip_num : max_index;

	mini_distance = FLT_MAX;

	for(i=start; i<end; i++)
	{
		float d = zkys_get_distance(gps_loc, &china_mogolia_boundary[i]);
		if(d < mini_distance)
		{
			mini_index= i;
			mini_distance = d;
		}
	}
#endif

	if(mini_index == -1)
	{
		printf("Not find the minimum distance!\n");
		return -1;
	}

	//2.calculate the minimun distance.
	if(mini_index == 0)
	{
		//if current position is between 0 and 1,angle(c-0-1) is less than 90, 
		//the distance is the hight of current position to the line of forming 0 to 1.
		// or, the minimum distance is the distance of current position to the 0 point of boundary.
		//cosA = (b*b + c*c - a*a) / (2*b*c), A is angle CAB

		float a, b, c, cos_A, angle_A;
		a = zkys_get_distance(gps_loc, &china_mogolia_boundary[mini_index + 1]);
		b = zkys_get_distance(gps_loc, &china_mogolia_boundary[mini_index]);
		c = zkys_get_distance(&china_mogolia_boundary[mini_index], &china_mogolia_boundary[mini_index + 1]);
		cos_A = (b*b + c*c - a*a) / (2*b*c);
		angle_A = acos(cos_A); //0 - pi

		distance_tmp = angle_A >= M_PI / 2 ? b : b * sin(angle_A);
	}
	else if(mini_index == max_index -1)
	{
		//angle(c - (max_index-1) - (max_index-2)) is less than 90, current position is between them.
		//or,the minimum distance is the idstance of current position to the max-1 point of boundary.

		float a, b, c, cos_A, angle_A;
		a = zkys_get_distance(gps_loc, &china_mogolia_boundary[mini_index - 1]);
		b = zkys_get_distance(gps_loc, &china_mogolia_boundary[mini_index]);
		c = zkys_get_distance(&china_mogolia_boundary[mini_index], &china_mogolia_boundary[mini_index - 1]);
		cos_A = (b*b + c*c - a*a) / (2*b*c);
		angle_A = acos(cos_A); //0 - pi

		distance_tmp = angle_A >= M_PI / 2 ? b : b * sin(angle_A);
	}
	else
	{
		float a_1, b_1, c_1, cos_A_1, angle_A_1;
		float a_2, b_2, c_2, cos_A_2, angle_A_2;
		float d_1, d_2;

		a_1 = zkys_get_distance(gps_loc, &china_mogolia_boundary[mini_index - 1]);
		b_1 = zkys_get_distance(gps_loc, &china_mogolia_boundary[mini_index]);
		c_1 = zkys_get_distance(&china_mogolia_boundary[mini_index], &china_mogolia_boundary[mini_index - 1]);

		a_2 = zkys_get_distance(gps_loc, &china_mogolia_boundary[mini_index + 1]);
		b_2 = b_1;
		c_2 = zkys_get_distance(&china_mogolia_boundary[mini_index], &china_mogolia_boundary[mini_index + 1]);

		cos_A_1 = (b_1*b_1 + c_1*c_1 - a_1*a_1) / (2*b_1*c_1);
		angle_A_1 = acos(cos_A_1); //0 - pi

		cos_A_2 = (b_2*b_2 + c_2*c_2 - a_2*a_2) / (2*b_2*c_2);
		angle_A_2 = acos(cos_A_2); //0 - pi

		d_1 = angle_A_1 >= M_PI / 2 ? b_1 : b_1 * sin(angle_A_1);
		d_2 = angle_A_2 >= M_PI / 2 ? b_2 : b_2 * sin(angle_A_2);

		distance_tmp = d_1 < d_2 ? d_1 : d_2;
	}

	if(distance_tmp >= 0)
	{
		*distance = distance_tmp;
		return distance_tmp > fence_threshold ?  0 : 1;
	}

	return -1;
}
